# Multi-Tenant SaaS â€” Project Overview

> **Last Updated:** February 2026  
> **Stack:** AWS Â· Terraform Â· Kubernetes (k3s) Â· Node.js Lambdas Â· Next.js 16 Â· Prisma Â· PostgreSQL Â· RabbitMQ

This document provides a detailed walkthrough of everything that has been built in this project so far, organized by component.

---

## Table of Contents

1. [Project Structure](#1-project-structure)
2. [Infrastructure â€” Terraform](#2-infrastructure--terraform)
3. [Kubernetes Manifests](#3-kubernetes-manifests)
4. [Backend Lambdas](#4-backend-lambdas)
5. [Frontend (Next.js)](#5-frontend-nextjs)
6. [Scripts & Automation](#6-scripts--automation)
7. [Documentation](#7-documentation)
8. [Current Status & What's Next](#8-current-status--whats-next)

---

## 1. Project Structure

```
MultiTenantSaas/
â”œâ”€â”€ terraform/              # AWS infrastructure as code
â”‚   â”œâ”€â”€ main.tf             # VPC, EC2, security groups, IAM, auto-shutdown
â”‚   â”œâ”€â”€ api_gateway.tf      # REST + WebSocket API Gateway
â”‚   â”œâ”€â”€ lambda.tf           # Lambda function definitions & permissions
â”‚   â”œâ”€â”€ secrets.tf          # AWS Secrets Manager resources
â”‚   â”œâ”€â”€ logging.tf          # CloudWatch + CloudTrail logging
â”‚   â”œâ”€â”€ provider.tf         # AWS provider config
â”‚   â”œâ”€â”€ variables.tf        # Input variables
â”‚   â””â”€â”€ outputs.tf          # Output values (IPs, URLs, etc.)
â”‚
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ k8s/                # Kubernetes manifests
â”‚   â”‚   â”œâ”€â”€ postgresql.yaml
â”‚   â”‚   â”œâ”€â”€ pgbouncer.yaml
â”‚   â”‚   â”œâ”€â”€ cloudwatch-logging.yaml
â”‚   â”‚   â””â”€â”€ rabbitmq/
â”‚   â”‚       â”œâ”€â”€ rabbitmq.yaml
â”‚   â”‚       â””â”€â”€ README.md
â”‚   â”‚
â”‚   â”œâ”€â”€ lambdas/            # AWS Lambda functions (JavaScript / Node.js)
â”‚   â”‚   â”œâ”€â”€ authorizer/     # JWT validation Lambda
â”‚   â”‚   â”œâ”€â”€ orchestrator/   # Permission-gated business logic Lambda
â”‚   â”‚   â”œâ”€â”€ stub/           # Placeholder Lambda for WebSocket
â”‚   â”‚   â””â”€â”€ utils/          # Shared auth & permission helpers
â”‚   â”‚
â”‚   â””â”€â”€ scripts/            # Shell scripts for secrets management
â”‚       â”œâ”€â”€ bootstrap-aws-secrets.sh
â”‚       â””â”€â”€ sync-secrets.sh
â”‚
â”œâ”€â”€ frontend/               # Next.js 16 application
â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â”œâ”€â”€ schema.prisma   # Multi-tenant data model
â”‚   â”‚   â””â”€â”€ seed.ts         # Default roles & permissions seeder
â”‚   â””â”€â”€ src/
â”‚       â””â”€â”€ lib/
â”‚           â””â”€â”€ auth-enrichment.ts  # JWT enrichment logic
â”‚
â”œâ”€â”€ bin/                    # Terraform binary
â”œâ”€â”€ Makefile                # Automation shortcuts
â”œâ”€â”€ DESIGN_ARCH.md          # Architecture documentation
â”œâ”€â”€ RBAC_WORKFLOW.md        # RBAC design documentation
â”œâ”€â”€ INFRA_RUNBOOK.md        # Infrastructure runbook
â””â”€â”€ LICENSE.txt
```

---

## 2. Infrastructure â€” Terraform

All AWS infrastructure is defined in `terraform/` and can be provisioned with `terraform apply`.

### 2.1 Networking (`main.tf`)

| Resource | Purpose |
|---|---|
| **VPC** (`10.0.0.0/16`) | Isolated network for the entire platform |
| **Public Subnet** (`10.0.1.0/24`) | Hosts the EC2 instance with public IP |
| **Internet Gateway** | Enables outbound internet access |
| **Route Table** | Routes all traffic (`0.0.0.0/0`) through the gateway |

### 2.2 Compute (`main.tf`)

A single **EC2 instance** (`t3.medium`) running **Ubuntu 22.04 LTS** is bootstrapped with:
- **k3s** â€” a lightweight Kubernetes distribution installed automatically via `user_data`
- **Essential tools** â€” `jq`, `unzip`, and `postgresql-client`

An **RSA-4096 SSH key pair** is auto-generated by Terraform and saved locally as a `.pem` file for SSH access.

### 2.3 Security (`main.tf`)

The **Security Group** allows:
- **Port 22** â€” SSH access (should be restricted in production)
- **Port 6443** â€” k3s API server
- **Ports 30000â€“32767** â€” Kubernetes NodePort range
- **All internode traffic** within the security group
- **All outbound** traffic

**IAM Role** attached to the EC2 instance includes:
- `AmazonSSMManagedInstanceCore` â€” enables AWS Systems Manager (SSM) for console access without SSH
- `CloudWatchAgentServerPolicy` â€” allows the instance to push metrics/logs to CloudWatch

### 2.4 Cost Control (`main.tf`)

A **CloudWatch Metric Alarm** monitors CPU utilization:
- If CPU stays **below 5%** for **12 consecutive 5-minute periods** (60 minutes total), the instance is **automatically stopped**
- This prevents unnecessary costs when the dev/staging environment is idle

### 2.5 API Gateway (`api_gateway.tf`)

Two API Gateways are provisioned:

**REST API** (`/api/*`):
- Three resource paths: `/api/agents`, `/api/users`, `/api/orgs`
- All routes use `ANY` HTTP method
- All routes are protected by the **custom Lambda Authorizer** (JWT validation)
- All routes integrate with the **Orchestrator Lambda** via `AWS_PROXY`
- Deployed to a `prod` stage

**WebSocket API**:
- Route selection based on `$request.body.action`
- Routes: `$connect`, `$disconnect`, `$default`, and `task-status`
- `$connect` is protected by the same Lambda Authorizer
- All routes integrate with the **Stub Lambda** (placeholder for real-time features)
- Auto-deployed to a `prod` stage

### 2.6 Lambda Functions (`lambda.tf`)

Three Lambda functions are defined (all `nodejs18.x`):

| Function | Source | Purpose |
|---|---|---|
| `api-stub` | `lambdas/stub/index.js` | Placeholder for WebSocket endpoints |
| `orchestrator` | `lambdas/orchestrator/` (zipped directory) | Business logic with permission checking |
| `authorizer` | `lambdas/authorizer/` (zipped directory) | JWT validation for API Gateway |

**Permissions** are configured so API Gateway can invoke each Lambda for both REST and WebSocket APIs.

The **Authorizer** Lambda has an environment variable `JWT_KEY` set to `"development-secret"` (placeholder â€” should be synced from Secrets Manager in production).

### 2.7 Secrets Management (`secrets.tf`)

AWS Secrets Manager is used to store three secrets:
- **Database password** (`multi-tenant-saas-db-password`)
- **JWT signing key** (`multi-tenant-saas-jwt-key`)
- **LLM API keys** (`multi-tenant-saas-llm-keys`) â€” for future AI/agent features

### 2.8 Logging & Auditing (`logging.tf`)

- **CloudWatch Log Group** â€” receives k3s cluster logs pushed by Fluent Bit
- **CloudTrail** â€” logs all AWS API calls (infrastructure mutations) to an S3 bucket for compliance auditing

---

## 3. Kubernetes Manifests

All manifests deploy into a `data` namespace and define the data/messaging layer.

### 3.1 PostgreSQL (`postgresql.yaml`)

- **StatefulSet** running PostgreSQL v15
- **PersistentVolume** for durable data storage
- **Headless Service** for stable DNS and internal cluster communication
- Database: `saas_db`, User: `saas_admin`

### 3.2 PgBouncer (`pgbouncer.yaml`)

- **Connection pooler** sitting between application code and PostgreSQL
- Listens on **port 6432**
- Efficiently manages database connections across multiple Lambdas and the frontend
- Prevents connection exhaustion under high concurrency

### 3.3 RabbitMQ (`rabbitmq/rabbitmq.yaml`)

- **3-node StatefulSet** for high availability
- Uses **k8s peer discovery** for automatic cluster formation
- Handles **asynchronous task orchestration** â€” the Orchestrator Lambda publishes tasks here for background processing
- Includes a `README.md` with cluster-specific notes

### 3.4 CloudWatch Logging (`cloudwatch-logging.yaml`)

- **Fluent Bit DaemonSet** â€” runs on every node in the k3s cluster
- Collects container logs from all pods and forwards them to **AWS CloudWatch**
- Enables centralized log monitoring without SSH-ing into the cluster

---

## 4. Backend Lambdas

All Lambda functions are written in **JavaScript (Node.js 18.x)**. They form the API and security backbone of the platform.

### 4.1 Lambda Authorizer (`lambdas/authorizer/`)

**Files:** `index.js`, `auth_util.js`, `package.json`

**Purpose:** Intercepts every API Gateway request and validates the JWT token before it reaches any backend service.

**How it works:**
1. Extracts the `Authorization: Bearer <token>` header from the incoming request
2. Calls `verifyToken()` to validate the JWT signature and expiration
3. If **invalid/missing** â†’ returns an IAM `Deny` policy (request is blocked)
4. If **valid** â†’ returns an IAM `Allow` policy and forwards decoded claims into the `requestContext`:
   - `org_id` â€” the tenant/organization this user belongs to
   - `permissions` â€” JSON-stringified array of permission strings
   - `email` â€” the user's email address

**`auth_util.js`** provides two functions:
- `createEnrichedToken(user, orgId, permissions)` â€” signs a JWT with the user's identity, organization, and flattened permissions. Tokens expire after **60 minutes**.
- `verifyToken(token)` â€” verifies and decodes a JWT. Returns `null` if invalid.

Both functions use `process.env.JWT_KEY` (falling back to `"development-secret"`).

### 4.2 Agent Orchestrator (`lambdas/orchestrator/`)

**Files:** `index.js`, `permissions.js`

**Purpose:** The central business logic Lambda. Every authorized REST API request (`/api/agents`, `/api/users`, `/api/orgs`) is routed here.

**How it works:**
1. Extracts the **Authorizer context** (org_id, permissions) from `event.requestContext.authorizer`
2. Determines the **required permission** based on the request path and HTTP method:
   - `POST /api/agents` â†’ requires `agents:create`
   - `POST /api/users` â†’ requires `users:manage`
   - `PUT /api/orgs` â†’ requires `org:manage`
   - Everything else â†’ requires `read`
3. Calls `hasPermission()` to check if the user's permissions include the required one
4. If **denied** â†’ returns `403 Forbidden` with a descriptive error
5. If **allowed** â†’ returns `200 OK` with a success message (placeholder for future RabbitMQ task publishing)

**`permissions.js`** provides:
- `hasPermission(context, requiredPermission)` â€” parses the permissions JSON from the context and checks for either a wildcard (`*`) match (Global Admin) or an exact permission match
- `getOrgId(context)` â€” extracts the `org_id` from the context

### 4.3 Stub Lambda (`lambdas/stub/`)

**File:** `index.js`

A minimal placeholder Lambda that returns `200 OK` for any event. Used as the integration target for all **WebSocket API** routes (`$connect`, `$disconnect`, `$default`, `task-status`). Will be replaced with real-time task status streaming logic in the future.

### 4.4 Shared Utilities (`lambdas/utils/`)

**Files:** `auth.js`, `permissions.js`

These are **identical copies** of `authorizer/auth_util.js` and `orchestrator/permissions.js` respectively. They serve as reusable modules that can be imported by any Lambda or service that needs JWT or permission functionality.

---

## 5. Frontend (Next.js)

The frontend is a **Next.js 16** application with **React 19**, **TypeScript**, and **Tailwind CSS 4**.

### 5.1 Prisma Schema (`prisma/schema.prisma`)

Defines the **multi-tenant RBAC data model** backed by PostgreSQL (via PgBouncer on port 6432):

| Model | Purpose |
|---|---|
| **Organization** | A tenant (company/customer). Has `id`, `name`, `slug` (unique), timestamps. |
| **User** | A global unique identity. Has `id`, `email` (unique), `name`, timestamps. |
| **Role** | A named collection of permissions (e.g., `SUPER_ADMIN`, `TENANT_ADMIN`, `USER`). |
| **Permission** | An atomic action string (e.g., `org:read`, `users:manage`, `agents:create`). |
| **RolePermission** | Many-to-many join table linking Roles to Permissions. Composite primary key `[roleId, permissionId]`. Cascade deletes. |
| **UserOrganizationRole** | The **core multi-tenant link**. Assigns a User a specific Role *within* a specific Organization. The `organizationId` is **nullable** to support Global Super Admins who aren't tied to any single org. Unique constraint on `[userId, organizationId, roleId]`. |

### 5.2 Seed Script (`prisma/seed.ts`)

Seeds the database with **default permissions and roles** using upsert (safe to re-run):

**Permissions created:**
| Permission | Description |
|---|---|
| `*` | Full system access (wildcard) |
| `org:read` | View organization details |
| `org:manage` | Modify organization settings |
| `users:read` | View users in the organization |
| `users:manage` | Create, edit, or delete users |

**Roles created and linked:**
| Role | Permissions |
|---|---|
| `SUPER_ADMIN` | `*` (full access) |
| `TENANT_ADMIN` | `org:read`, `users:manage`, `users:read` |
| `USER` | `org:read`, `users:read` |

### 5.3 Auth Enrichment (`src/lib/auth-enrichment.ts`)

The **Federated Adapter Enrichment** logic. When a user logs in:
1. Queries the database via Prisma for all `UserOrganizationRole` records matching the `userId` and `organizationId`
2. Includes the nested `Role â†’ RolePermission â†’ Permission` relationships
3. Flattens all permission names into a deduplicated `Set`
4. Returns `{ orgId, permissions[] }` â€” which is then embedded into the Enriched JWT

### 5.4 UI / Pages

**No pages or UI components have been built yet.** The `src/` directory only contains `lib/auth-enrichment.ts`. There are no `app/` routes, layouts, or React components. The frontend Dockerfile exists but the application has no user-facing screens.

---

## 6. Scripts & Automation

### 6.1 Bootstrap Secrets (`backend/scripts/bootstrap-aws-secrets.sh`)

Initializes secrets in **AWS Secrets Manager** from environment variables:
```bash
DB_PASSWORD=xxx JWT_KEY=xxx LLM_KEYS='{"openai":"..."}' ./bootstrap-aws-secrets.sh
```
Creates or updates three secrets:
- `multi-tenant-saas-db-password`
- `multi-tenant-saas-jwt-key`
- `multi-tenant-saas-llm-keys`

### 6.2 Sync Secrets (`backend/scripts/sync-secrets.sh`)

Pulls secrets from AWS Secrets Manager and creates corresponding **Kubernetes Secrets** in the `data` namespace:
- Detects whether the secret value is plain text or JSON
- Uses `kubectl create secret ... --dry-run=client | kubectl apply` for idempotent updates
- Maps: DB password â†’ `db-credentials`, JWT key â†’ `jwt-key`, LLM keys â†’ `llm-keys`

### 6.3 Makefile

Provides shortcuts for common operations:

| Command | Action |
|---|---|
| `make deploy-infra` | Runs `terraform-apply` then `k8s-deploy` end-to-end |
| `make terraform-apply` | Initializes and applies Terraform config |
| `make k8s-deploy` | Creates the `data` namespace and applies all k8s manifests (PostgreSQL, RabbitMQ, PgBouncer, CloudWatch logging) |
| `make sync-secrets` | Runs the secrets sync script |
| `make bootstrap-secrets` | Runs the secrets bootstrap script |

---

## 7. Documentation

| Document | Description |
|---|---|
| `DESIGN_ARCH.md` | High-level system architecture covering infrastructure, data, security, API, and observability layers |
| `RBAC_WORKFLOW.md` | Detailed RBAC design â€” data model, default roles/permissions, and the 4-step zero-trust security flow |
| `INFRA_RUNBOOK.md` | Step-by-step guide for provisioning the full infrastructure (Terraform â†’ K8s â†’ Secrets â†’ Deployment â†’ Verification) |

---

## 8. Current Status & What's Next

### âœ… Completed
- Full AWS infrastructure via Terraform (VPC, EC2/k3s, API Gateway, Lambdas, Secrets, Logging)
- Kubernetes data layer (PostgreSQL, PgBouncer, RabbitMQ, Fluent Bit)
- Lambda Authorizer with JWT validation and enriched token generation
- Lambda Orchestrator with fine-grained RBAC permission checking
- Prisma multi-tenant data model with User â†” Organization â†” Role relationships
- Database seed script with default roles and permissions
- Auth enrichment logic for JWT token generation
- Shell scripts for secrets bootstrapping and Kubernetes sync
- Makefile for one-command deployments
- Comprehensive architecture, RBAC, and runbook documentation

### ðŸ”² Not Yet Built
- **Frontend UI** â€” no pages, routes, or React components exist
- **User authentication flow** â€” login/signup pages and session management
- **Real-time features** â€” WebSocket `task-status` route is using a stub Lambda
- **RabbitMQ integration** â€” the Orchestrator acknowledges tasks but doesn't actually publish to RabbitMQ yet
- **CI/CD pipeline** â€” `.github/` directory exists but contents are minimal
- **Production hardening** â€” SSH security group is open to `0.0.0.0/0`, JWT key is hardcoded as a fallback

---

*This document was auto-generated based on a full analysis of the codebase as of February 2026.*
